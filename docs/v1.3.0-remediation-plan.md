# v1.3.0 Remediation Plan

**Date**: January 1, 2026  
**Status**: Planning  
**Priority**: Critical  
**Target**: Fix race conditions, stale configs, and provide clean upgrade path from all prior versions

---

## Executive Summary

Users upgrading from v1.0.0–v1.2.x to v1.3.0 are experiencing issues due to:
1. **Race condition** between systemd service and NetworkManager dispatcher
2. **Stale configuration files** left behind from prior versions
3. **No proper uninstall mechanism** to clean up before upgrade
4. **Dispatcher delays** preventing immediate CAKE application

This document outlines the complete remediation plan.

---

## Part 1: Version Archaeology

### Files Created by Each Version

#### v1.0.0 (Initial Release)
| File | Purpose | Status in v1.3.0 |
|------|---------|------------------|
| `/usr/local/bin/hifi-wifi` | Main binary | Still used |
| `/usr/local/share/hifi-wifi/` | Shared files | Still used |
| `/etc/modprobe.d/rtw89.conf` | Realtek driver config | Still used |
| `/etc/modprobe.d/rtw89_advanced.conf` | Realtek advanced config | Still used |
| `/etc/udev/rules.d/70-wifi-powersave.rules` | Power save udev rule | Still used |
| `/var/lib/wifi_patch/applied.flag` | State flag | Still used |

#### v1.1.0 (Persistence & iwd)
| File | Purpose | Status in v1.3.0 |
|------|---------|------------------|
| `/var/lib/hifi-wifi/` | SteamOS persistence directory | Still used |
| `/var/lib/hifi-wifi/backup/` | Backup files for restore | Still used |
| `/var/lib/hifi-wifi/pkg_cache/` | Cached packages for offline restore | Still used |
| `/etc/systemd/system/hifi-wifi-restore.service` | SteamOS update persistence | Still used |
| `/etc/NetworkManager/conf.d/wifi_backend.conf` | **iwd backend switch** | **REMOVED in v1.2.1** |
| `/etc/NetworkManager/conf.d/iwd.conf` | **iwd backend config** | **REMOVED in v1.2.1** |
| `/etc/iwd/main.conf` | iwd optimization (if iwd active) | Conditional |

#### v1.2.0 (Stability & Timeouts)
| File | Purpose | Status in v1.3.0 |
|------|---------|------------------|
| `/etc/NetworkManager/dispatcher.d/99-wifi-auto-optimize` | Auto-apply on connect | Still used |
| `/var/lib/wifi_patch/networks/` | **Network profile cache** | **REMOVED in v1.3.0** |
| `/var/lib/wifi_patch/networks/<ssid>.profile` | **Per-network bandwidth cache** | **REMOVED in v1.3.0** |

#### v1.2.1 (Backend Removal Hotfix)
| File | Purpose | Status in v1.3.0 |
|------|---------|------------------|
| Aggressive cleanup of `*hifi*.conf` | Removes legacy backend configs | Still needed |

#### v1.2.2 (Speedtest)
| File | Purpose | Status in v1.3.0 |
|------|---------|------------------|
| `speedtest-cli` dependency | Bandwidth measurement | **REMOVED in v1.3.0** |
| Tele2/Cloudflare test endpoints | Bandwidth measurement | **REMOVED in v1.3.0** |

#### v1.3.0 (Current)
| File | Purpose | Notes |
|------|---------|-------|
| `/etc/systemd/system/wifi-cake-qdisc@.service` | CAKE on boot | **REDUNDANT - causes race condition** |
| `/etc/systemd/system/wifi-optimizations-verify.service` | Verify after updates | Keep |
| `/etc/NetworkManager/conf.d/99-hifi-wifi-powersave.conf` | Force disable power save | Keep |
| `/var/lib/wifi_patch/bandwidth_<ifc>.txt` | Bandwidth for systemd service | **REMOVE with service** |
| `/var/lib/wifi_patch/upload_bandwidth_<ifc>.txt` | Upload bandwidth | **REMOVE with service** |
| `/etc/udev/rules.d/70-wifi-powersave-<ifc>.rules` | Per-interface power save | Keep |
| `/usr/local/bin/wifi-desktop-performance.sh` | Desktop performance script | Keep |

---

## Part 2: Root Cause Analysis

### Issue 1: Race Condition (CRITICAL)

**Two mechanisms apply CAKE:**

```
┌─────────────────────────────────────────────────────────────────┐
│                         BOOT SEQUENCE                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [systemd]                          [NetworkManager]             │
│      │                                     │                     │
│      ▼                                     │                     │
│  wifi-cake-qdisc@wlan0.service             │                     │
│  (reads stale bandwidth file)              │                     │
│      │                                     │                     │
│      ▼                                     ▼                     │
│  tc qdisc replace... (maybe wrong)    Connection UP event        │
│                                            │                     │
│                                            ▼                     │
│                                    99-wifi-auto-optimize         │
│                                    (measures fresh link speed)   │
│                                            │                     │
│                                            ▼                     │
│                                    sleep 2 (wait for stable)     │
│                                            │                     │
│                                            ▼                     │
│                                    is_network_idle() [+2s]       │
│                                            │                     │
│                                            ▼                     │
│                                    tc qdisc replace... (correct) │
│                                                                  │
│  RESULT: 4+ second delay before correct CAKE applied             │
│  USER SEES: Bufferbloat/stutter until Wi-Fi menu opened          │
└─────────────────────────────────────────────────────────────────┘
```

**Solution**: Remove `wifi-cake-qdisc@.service` entirely. Dispatcher is the single source of truth.

### Issue 2: Stale Bandwidth Files

Users upgrading from v1.2.x have `/var/lib/wifi_patch/bandwidth_*.txt` files with old values. The systemd service reads these and applies incorrect limits.

**Solution**: Clean up bandwidth files as part of upgrade/uninstall.

### Issue 3: Dispatcher Delays

Current dispatcher has **4+ seconds** of delays:
- Line 157: `sleep 2` - "Wait for connection to stabilize"
- Line 82: `sleep 2` - Inside `is_network_idle()` function
- Lines 159-166: `is_network_idle()` check

**Solution**: Reduce `sleep 2` to `sleep 1` (keep minimal delay for link speed accuracy). Remove `is_network_idle()` check entirely (legacy from speedtest days).

### Issue 4: No Uninstall Script

Users have no way to cleanly remove hifi-wifi before upgrading or troubleshooting.

**Solution**: Create `uninstall.sh` that removes ALL artifacts from ALL versions.

---

## Part 3: Implementation Plan

### Phase 1: Create `uninstall.sh` (Priority: CRITICAL)

Create a standalone uninstall script that:

```bash
#!/bin/bash
# uninstall.sh - Complete removal of hifi-wifi (all versions)

# 1. Run --revert if installed
if command -v hifi-wifi &>/dev/null; then
    sudo hifi-wifi --revert --quiet || true
fi

# 2. Stop and disable ALL systemd services
sudo systemctl stop wifi-cake-qdisc@*.service 2>/dev/null || true
sudo systemctl disable wifi-cake-qdisc@*.service 2>/dev/null || true
sudo systemctl stop wifi-optimizations-verify.service 2>/dev/null || true
sudo systemctl disable wifi-optimizations-verify.service 2>/dev/null || true
sudo systemctl stop hifi-wifi-restore.service 2>/dev/null || true
sudo systemctl disable hifi-wifi-restore.service 2>/dev/null || true

# 3. Remove systemd service files
sudo rm -f /etc/systemd/system/wifi-cake-qdisc@.service
sudo rm -f /etc/systemd/system/wifi-optimizations-verify.service
sudo rm -f /etc/systemd/system/hifi-wifi-restore.service
sudo systemctl daemon-reload

# 4. Remove binaries and shared files
sudo rm -f /usr/local/bin/hifi-wifi
sudo rm -f /usr/local/bin/wifi-power-manager.sh
sudo rm -f /usr/local/bin/wifi-desktop-performance.sh
sudo rm -rf /usr/local/share/hifi-wifi

# 5. Remove modprobe configs (ALL possible driver files)
sudo rm -f /etc/modprobe.d/rtw89.conf
sudo rm -f /etc/modprobe.d/rtw89_advanced.conf
sudo rm -f /etc/modprobe.d/rtw88.conf
sudo rm -f /etc/modprobe.d/rtl_legacy.conf
sudo rm -f /etc/modprobe.d/rtl8192ee.conf
sudo rm -f /etc/modprobe.d/rtl_wifi.conf
sudo rm -f /etc/modprobe.d/rtl8822ce.conf
sudo rm -f /etc/modprobe.d/mt7921e.conf
sudo rm -f /etc/modprobe.d/mediatek.conf
sudo rm -f /etc/modprobe.d/iwlwifi.conf
sudo rm -f /etc/modprobe.d/ath_wifi.conf
sudo rm -f /etc/modprobe.d/broadcom.conf
sudo rm -f /etc/modprobe.d/ralink.conf
sudo rm -f /etc/modprobe.d/marvell.conf
sudo rm -f /etc/modprobe.d/wifi_generic.conf

# 6. Remove udev rules
sudo rm -f /etc/udev/rules.d/70-wifi-powersave.rules
sudo rm -f /etc/udev/rules.d/70-wifi-powersave-*.rules
sudo rm -f /etc/udev/rules.d/70-wifi-power-ac.rules

# 7. Remove NetworkManager configs
sudo rm -f /etc/NetworkManager/dispatcher.d/99-wifi-auto-optimize
sudo rm -f /etc/NetworkManager/conf.d/99-hifi-wifi-powersave.conf
sudo rm -f /etc/NetworkManager/conf.d/*hifi*.conf
sudo rm -f /etc/NetworkManager/conf.d/wifi_backend.conf
sudo rm -f /etc/NetworkManager/conf.d/iwd.conf

# 8. Remove sysctl configs
sudo rm -f /etc/sysctl.d/99-wifi-upload-opt.conf

# 9. Remove state directories
sudo rm -rf /var/lib/wifi_patch
sudo rm -rf /var/lib/hifi-wifi

# 10. Remove iwd config (only if we created it)
if [[ -f "/etc/iwd/main.conf" ]]; then
    if grep -q "BandModifier6GHz=3.0" "/etc/iwd/main.conf"; then
        sudo rm -f /etc/iwd/main.conf
    fi
fi

# 11. Unmask wpa_supplicant
sudo systemctl unmask wpa_supplicant.service 2>/dev/null || true

# 12. Remove tc qdisc from all interfaces
for ifc in $(ip -o link show | awk -F': ' '{print $2}' | grep -E '^(wl|en|eth)'); do
    sudo tc qdisc del dev "$ifc" root 2>/dev/null || true
    sudo tc qdisc del dev "$ifc" ingress 2>/dev/null || true
done

# 13. Reload services
sudo udevadm control --reload-rules
sudo systemctl restart NetworkManager

echo "hifi-wifi has been completely uninstalled."
```

### Phase 2: Update `install.sh` (Priority: HIGH)

Add version-specific cleanup before installation:

```bash
# --- LEGACY CLEANUP (v1.0.0 - v1.2.x) ---
echo "Cleaning up legacy configurations..."

# v1.1.0 - v1.2.0: Backend configs (caused #5)
sudo rm -f /etc/NetworkManager/conf.d/wifi_backend.conf 2>/dev/null || true
sudo rm -f /etc/NetworkManager/conf.d/iwd.conf 2>/dev/null || true
sudo rm -f /etc/NetworkManager/conf.d/*hifi*.conf 2>/dev/null || true

# v1.2.0: Network profile cache (no longer used)
sudo rm -rf /var/lib/wifi_patch/networks 2>/dev/null || true

# v1.3.0-rc1: Stale bandwidth files (systemd service being removed)
sudo rm -f /var/lib/wifi_patch/bandwidth_*.txt 2>/dev/null || true
sudo rm -f /var/lib/wifi_patch/upload_bandwidth_*.txt 2>/dev/null || true

# v1.3.0-rc1: Disable redundant systemd CAKE service
if systemctl list-unit-files | grep -q "wifi-cake-qdisc@"; then
    echo "Disabling redundant CAKE systemd services..."
    sudo systemctl disable 'wifi-cake-qdisc@*.service' 2>/dev/null || true
    sudo systemctl stop 'wifi-cake-qdisc@*.service' 2>/dev/null || true
fi
sudo rm -f /etc/systemd/system/wifi-cake-qdisc@.service 2>/dev/null || true

# Unmask wpa_supplicant (v1.1.0 issue)
sudo systemctl unmask wpa_supplicant.service 2>/dev/null || true

sudo systemctl daemon-reload
```

### Phase 3: Remove `wifi-cake-qdisc@.service` from `core.sh` (Priority: HIGH)

**Remove from `apply_patches()`:**
- Lines 447-462: Service file creation
- Lines 561-562: Service enabling

**Keep:**
- Dispatcher installation (line 588-589)
- `wifi-optimizations-verify.service` (useful for immutable systems)
- CAKE application during `--apply` (immediate effect)

### Phase 4: Optimize Dispatcher (Priority: MEDIUM)

**Changes to `dispatcher.sh`:**

1. **Reduce initial delay**: `sleep 2` → `sleep 1`
   - Rationale: 1 second is enough for link to stabilize
   - Full removal risks inaccurate link speed on some hardware

2. **Remove `is_network_idle()` check entirely**
   - Legacy from speedtest days - not needed with instant link statistics
   - Removes additional 2s delay

3. **Add timeout to link speed detection**
   - Prevent hanging on broken interfaces

**New dispatcher flow:**
```
Connection UP → sleep 1 → get_link_speed() → apply CAKE → set power_save
Total time: ~1.5 seconds
```

### Phase 5: Update `revert_patches()` in `core.sh` (Priority: MEDIUM)

Ensure revert cleans up:
- `wifi-cake-qdisc@.service` (all instances)
- `wifi-cake-qdisc@*.service` (enabled instances)
- Bandwidth files in `/var/lib/wifi_patch/`
- IFB interfaces

---

## Part 4: Testing Checklist

### Fresh Install Tests
- [ ] Install on clean SteamOS (no prior hifi-wifi)
- [ ] Install on clean Bazzite (no prior hifi-wifi)
- [ ] Verify CAKE applied within 2 seconds of connection
- [ ] Verify power save correctly disabled on AC
- [ ] Verify no systemd CAKE service created

### Upgrade Tests
- [ ] Upgrade from v1.0.0 → v1.3.0
- [ ] Upgrade from v1.1.0 → v1.3.0
- [ ] Upgrade from v1.2.0 → v1.3.0
- [ ] Upgrade from v1.2.1 → v1.3.0
- [ ] Upgrade from v1.2.2 → v1.3.0
- [ ] Upgrade from v1.3.0-rc1 → v1.3.0

### Uninstall Tests
- [ ] Uninstall leaves no orphan files
- [ ] Uninstall restores default NetworkManager behavior
- [ ] Uninstall allows clean reinstall
- [ ] Uninstall works on SteamOS read-only filesystem

### Race Condition Tests
- [ ] Reboot → Wi-Fi connects → streaming works immediately (no menu workaround)
- [ ] Sleep/Wake → Wi-Fi reconnects → streaming works immediately
- [ ] Network switch → streaming works immediately

---

## Part 5: Deliverables

| Deliverable | File | Status |
|-------------|------|--------|
| Uninstall script | `uninstall.sh` | TODO |
| Updated installer | `install.sh` | TODO |
| Remove systemd service | `src/core.sh` | TODO |
| Optimize dispatcher | `src/dispatcher.sh` | TODO |
| Update revert logic | `src/core.sh` | TODO |
| Release notes | `release_notes/v1.3.0.md` | EXISTS |
| Updated README | `README.md` | TODO |

---

## Part 6: Rollout Plan

1. **Implement all changes on `dev` branch**
2. **Create v1.3.0-rc2 pre-release on `testing` branch**
3. **Request testers from Issues #5 and #6 to validate**
4. **Merge to `main` and tag v1.3.0 stable release**

---

## Appendix: Quick Recovery Commands

For users stuck with broken hifi-wifi, provide these commands:

```bash
# Emergency uninstall (run if install.sh hangs or breaks)
curl -fsSL https://raw.githubusercontent.com/doughty247/hifi-wifi/main/uninstall.sh | sudo bash
```

Or manual:
```bash
# Stop services
sudo systemctl stop wifi-cake-qdisc@*.service 2>/dev/null
sudo systemctl disable wifi-cake-qdisc@*.service 2>/dev/null
sudo rm -f /etc/systemd/system/wifi-cake-qdisc@.service
sudo systemctl daemon-reload

# Remove configs
sudo rm -f /etc/NetworkManager/dispatcher.d/99-wifi-auto-optimize
sudo rm -f /etc/NetworkManager/conf.d/*hifi*.conf
sudo rm -rf /var/lib/wifi_patch

# Restart NetworkManager
sudo systemctl restart NetworkManager
```
