#!/usr/bin/env bash
# wifi-diagnose.sh
# A script to help diagnose and optionally patch / revert Wi-Fi tweaks on Bazzite Linux

set -euo pipefail

# Resolve script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if running from source or installed
if [[ -f "$SCRIPT_DIR/../src/lib.sh" ]]; then
    # Running from source
    PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
    LIB_PATH="$PROJECT_ROOT/src/lib.sh"
    CORE_PATH="$PROJECT_ROOT/src/core.sh"
elif [[ -f "/usr/local/share/hifi-wifi/src/lib.sh" ]]; then
    # Installed system-wide
    PROJECT_ROOT="/usr/local/share/hifi-wifi"
    LIB_PATH="$PROJECT_ROOT/src/lib.sh"
    CORE_PATH="$PROJECT_ROOT/src/core.sh"
else
    echo "Error: Could not find library files."
    exit 1
fi

# Source library
source "$LIB_PATH"
source "$CORE_PATH"

# Global flags
APPLY=0
REVERT=0
NO_DIAG=0
INTERFACE=""
QUIET=0
NO_COLOR=0
DRY_RUN=0
SHOW_STATUS=0
LIST_BACKUPS=0
LIST_NETWORKS=0
VIEW_LOG=0
FORCE_PERFORMANCE=0

function usage() {
    cat <<EOF
Wi-Fi Diagnostic & Patch Tool v$VERSION
Usage: $0 [options]

Options:
    --apply            Apply performance / stability patches
    --revert           Revert previously applied patches
    --status           Show current patch status
    --list-backups     List available connection backups
    --list-networks    List saved network profiles
    --view-log         View auto-optimization log
    --interface IFACE  Specify Wi-Fi interface (auto-detect if omitted)
    --no-diagnose      Skip diagnostic sections (only apply/revert)

    --force-performance Disable power-saving even on battery (prevents jitter)
    --dry-run          Show what would be changed without making changes
    --quiet            Minimal output (log still captures full detail)
    --no-color         Disable colored output
    -h, --help         Show this help

Supported Systems:
    • Bazzite (immutable) - Full support with update protection
    • SteamOS (Steam Deck) - Full support, Gaming Mode compatible
    • Fedora, RHEL, CentOS - Full support
    • Other Linux distros - Generic support
EOF
}

# Argument parsing
while [[ $# -gt 0 ]]; do
    case "$1" in
        --apply) APPLY=1; shift ;;
        --revert) REVERT=1; shift ;;
        --status) SHOW_STATUS=1; shift ;;
        --force-performance) FORCE_PERFORMANCE=1; shift ;;
        --list-backups) LIST_BACKUPS=1; shift ;;
        --list-networks) LIST_NETWORKS=1; shift ;;
        --view-log) VIEW_LOG=1; shift ;;
        --interface) 
            if [[ -z "${2:-}" ]]; then
                log_error "--interface requires an argument"
                exit 1
            fi
            INTERFACE="$2"; shift 2 ;;
        --no-diagnose) NO_DIAG=1; shift ;;
        --dry-run) DRY_RUN=1; shift ;;
        --quiet) QUIET=1; shift ;;
        --no-color) NO_COLOR=1; shift ;;
        -h|--help) usage; exit 0 ;;
        *) log_error "Unknown argument: $1"; usage; exit 1 ;;
    esac
done

if [[ $APPLY -eq 1 && $REVERT -eq 1 ]]; then
    log_error "Can't use --apply and --revert together"
    exit 1
fi

if [[ ${DRY_RUN:-0} -eq 1 && ($APPLY -eq 1 || $REVERT -eq 1) ]]; then
    log_info "Dry-run mode enabled - no changes will be made"
fi

if [[ $APPLY -eq 1 || $REVERT -eq 1 ]]; then
    if [[ $EUID -ne 0 ]]; then
        log_error "Apply/Revert actions require root. Re-run with sudo."
        exit 1
    fi
    
    # Disable readonly filesystem on SteamOS early to avoid race conditions
    if [[ -f /etc/os-release ]]; then
        source /etc/os-release 2>/dev/null || true
        if [[ "$ID" == "steamos" ]] || [[ "${ID_LIKE:-}" =~ "steamos" ]]; then
            log_info "Detected SteamOS - disabling readonly filesystem..."
            steamos-readonly disable 2>/dev/null || {
                # Fallback method for older SteamOS
                btrfs property set -ts / ro false 2>/dev/null || true
            }
            log_success "Filesystem is now writable"
        fi
    fi
fi

# Check dependencies early
check_dependencies || exit 1

# Handle --status flag
if [[ $SHOW_STATUS -eq 1 ]]; then
    echo "======================================"
    echo "   Patch Status"
    echo "======================================"
    if [[ -f "$STATE_FLAG" ]]; then
        log_success "Patches are currently APPLIED"
        echo "Applied on: $(date -r "$STATE_FLAG")"
    else
        echo "Patches are NOT applied"
    fi
    
    echo ""
    echo "Active Optimizations:"
    if lsmod | grep -q rtw89_8852be; then
        echo "  [+] rtw89_8852be module loaded"
    fi
    
    ifc=$(detect_interface 2>/dev/null)
    if [[ -n "$ifc" ]]; then
        if tc qdisc show dev "$ifc" | grep -q "cake"; then
            echo "  [+] CAKE qdisc active on $ifc"
        else
            echo "  [-] CAKE qdisc NOT active on $ifc"
        fi
        
        if iw dev "$ifc" get power_save 2>/dev/null | grep -q "on"; then
            echo "  [-] Power save is ON (should be off for performance)"
        else
            echo "  [+] Power save is OFF (performance mode)"
        fi
    fi
    
    if [[ -f /etc/NetworkManager/dispatcher.d/99-wifi-auto-optimize ]]; then
        echo "  [+] Auto-optimization dispatcher installed"
    fi
    
    if systemctl is-enabled wifi-optimizations-verify.service &>/dev/null; then
        echo "  [+] Update verification service enabled"
    fi
    
    exit 0
fi

# Handle --list-backups
if [[ $LIST_BACKUPS -eq 1 ]]; then
    echo "======================================"
    echo "   Connection Backups"
    echo "======================================"
    ls -1 "$BACKUP_PREFIX"-*.txt 2>/dev/null | while read f; do
        uuid=$(basename "$f" | sed -E 's/backup-([0-9a-fA-F-]+)\.txt/\1/')
        date=$(date -r "$f")
        echo "UUID: $uuid (Backup date: $date)"
    done || echo "No backups found"
    exit 0
fi

# Handle --list-networks
if [[ $LIST_NETWORKS -eq 1 ]]; then
    list_network_profiles
    exit 0
fi

# Handle --view-log
if [[ $VIEW_LOG -eq 1 ]]; then
    LOGFILE="$STATE_DIR/auto-optimize.log"
    if [[ -f "$LOGFILE" ]]; then
        echo "======================================"
        echo "   Auto-Optimization Log (Last 50 lines)"
        echo "======================================"
        tail -n 50 "$LOGFILE"
    else
        log_error "Log file not found: $LOGFILE"
    fi
    exit 0
fi

# Main execution flow
[[ $QUIET -eq 1 ]] || {
  echo "======================================"
  # Detect OS Name for display
  OS_DISPLAY="Linux"
  if [[ -f /etc/os-release ]]; then
      # Run in subshell to avoid polluting global namespace and overwriting VERSION
      OS_DISPLAY=$(source /etc/os-release 2>/dev/null; 
          if [[ "$ID" == "steamos" ]] || [[ "${ID_LIKE:-}" =~ "steamos" ]]; then
              echo "SteamOS"
          elif [[ "$ID" == "bazzite" ]] || [[ "${NAME:-}" =~ "Bazzite" ]]; then
              echo "Bazzite"
          elif [[ -n "${NAME:-}" ]]; then
              echo "$NAME"
          else
              echo "Linux"
          fi
      )
  fi
  echo "   Wi-Fi Diagnostic Tool ($OS_DISPLAY)"
  if [[ ${DRY_RUN:-0} -eq 0 ]]; then
    echo "   Log File: $LOGFILE"
  fi
  echo "   Version: $VERSION"
  echo "======================================"
}

if [[ $REVERT -eq 1 ]]; then
  rm -f "$FORCE_PERF_FLAG" 2>/dev/null
  revert_patches
  [[ $NO_DIAG -eq 1 ]] && exit 0
fi

# --- SYSTEM INFO ---
echo -e "\n[1] System Info"
uname -a
lspci | grep -i network || echo "No PCI Wi-Fi adapter found"
lsusb | grep -i wireless || echo "No USB Wi-Fi adapter found"

# --- NETWORK INTERFACES ---
echo -e "\n[2] Network Interfaces"
ip link show
ip addr show
nmcli device status || echo "NetworkManager not detected"

# --- DRIVER CHECK ---
echo -e "\n[3] Wi-Fi Drivers & Firmware"
DRIVER_INFO=$(lspci -k | grep -A 3 -i network)
echo "$DRIVER_INFO"

# Detect hardware
detect_wifi_hardware || true

# Detect driver category
detect_driver_category

if [[ $APPLY -eq 1 ]]; then
    if [[ -f "$STATE_FLAG" ]]; then
        log_warning "Patch already marked applied (state flag exists). Use --revert first if you want a clean re-apply."
        [[ $NO_DIAG -eq 1 ]] && exit 0
    else
        # Handle force performance flag
        if [[ $FORCE_PERFORMANCE -eq 1 ]]; then
            touch "$FORCE_PERF_FLAG"
            log_info "Performance mode forced (power saving disabled)"
        fi

        if [[ -n "$DETECTED_DRIVER" ]] || [[ -n "$DRIVER_CATEGORY" ]]; then
            log_success "Wi-Fi hardware detected - applying optimizations..."
            apply_patches
        else
            log_warning "Wi-Fi hardware not detected, but will still apply universal optimizations"
            log_info "CAKE qdisc and network stack optimizations work on any Wi-Fi adapter"
            DRIVER_CATEGORY="generic"
            apply_patches
        fi
        [[ $NO_DIAG -eq 1 ]] && exit 0
    fi
else
    if [[ -n "$DETECTED_DRIVER" ]]; then
        log_info "Wi-Fi driver detected: $DETECTED_DRIVER"
        log_info "Run with --apply to optimize, or --revert to undo existing changes"
    else
        log_info "Wi-Fi driver auto-detection incomplete"
        log_info "Universal optimizations (CAKE qdisc) can still be applied with --apply"
    fi
    [[ $NO_DIAG -eq 1 ]] && exit 0
fi

# --- CURRENT WIFI CONNECTION ---
if [[ $NO_DIAG -eq 0 ]]; then
    echo -e "\n[4] Current Wi-Fi Connection"
    nmcli -t -f active,ssid,device dev wifi 2>/dev/null | grep yes || echo "Not connected to any Wi-Fi"



# --- CONNECTIVITY TEST ---
  echo -e "\n[5] Connectivity Test"
  ping -c 4 8.8.8.8 2>/dev/null || echo "Ping to 8.8.8.8 failed"
  ping -c 4 google.com 2>/dev/null || echo "DNS resolution or connectivity issue"

  echo -e "\n[5b] Bufferbloat Test"
  echo "[INFO] Testing latency under load (bufferbloat check)..."
  # Simple bufferbloat test: measure latency while generating load
  IFACE_TEST=$(detect_interface || echo "")
  if [[ -n "$IFACE_TEST" ]]; then
    echo "[TEST] Baseline latency:"
    ping -c 3 -W 2 8.8.8.8 2>/dev/null | grep "time=" | tail -1 || echo "Ping failed"
    
    echo "[TEST] Latency under upload load (5 second test):"
    # Generate upload traffic while measuring latency
    timeout 5 bash -c 'while true; do echo "bufferbloat test data $(date)" | nc -w1 8.8.8.8 80 2>/dev/null || true; done' &
    LOAD_PID=$!
    sleep 1
    ping -c 3 -W 2 8.8.8.8 2>/dev/null | grep "time=" | tail -1 || echo "Ping failed"
    kill $LOAD_PID 2>/dev/null || true
    wait $LOAD_PID 2>/dev/null || true
    
    echo "[TEST] Active Queue Management:"
    tc qdisc show dev "$IFACE_TEST" 2>/dev/null | head -1
  fi

  echo -e "\n[5c] Link Statistics"
  IFACE_SHOW=$(detect_interface || echo "")
  if [[ -n "$IFACE_SHOW" ]]; then
    iw dev "$IFACE_SHOW" link 2>/dev/null || true
    echo "[INFO] Hardware offload status:"
    ethtool -k "$IFACE_SHOW" 2>/dev/null | grep -E 'tcp-segmentation-offload|generic-receive-offload|generic-segmentation-offload' || true
    echo "[INFO] Network parameters:"
    sysctl net.ipv4.tcp_congestion_control 2>/dev/null || true
    sysctl net.core.default_qdisc 2>/dev/null || true
  fi

# --- LOGS ---
    echo -e "\n[6] System Logs (last 50 lines related to Wi-Fi)"
    journalctl -u NetworkManager -n 50 --no-pager || echo "No NetworkManager logs"
    dmesg | grep -i wifi | tail -n 50 || echo "No dmesg Wi-Fi logs"
fi

# Display summary
if [[ $QUIET -eq 0 ]]; then
    echo ""
    echo "======================================"
    echo "   Summary"
    echo "======================================"
    
    if [[ ${DRY_RUN:-0} -eq 0 ]]; then
        log_info "Diagnostics complete"
        log_info "Log saved to: $LOGFILE"
    fi
    
    if [[ $APPLY -eq 1 ]]; then
        if [[ -f "$STATE_FLAG" ]]; then
            log_success "Patches applied successfully"
            log_info "Use '$0 --revert' to undo changes"
            echo ""
            log_warning "A reboot is recommended"
            echo ""
            read -p "Reboot now to apply all changes? [Y/n]: " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Nn]$ ]]; then
                log_info "Skipping reboot. Reboot later with: sudo systemctl reboot"
            else
                log_info "Rebooting in 5 seconds... (Ctrl+C to cancel)"
                sleep 5
                systemctl reboot
            fi
        fi
    elif [[ $REVERT -eq 1 ]]; then
        if [[ ! -f "$STATE_FLAG" ]]; then
            log_success "Patches reverted successfully"
            echo ""
            log_warning "A reboot is recommended"
            echo ""
            read -p "Reboot now to fully revert changes? [Y/n]: " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Nn]$ ]]; then
                log_info "Skipping reboot. Reboot later with: sudo systemctl reboot"
            else
                log_info "Rebooting in 5 seconds... (Ctrl+C to cancel)"
                sleep 5
                systemctl reboot
            fi
        fi
    fi
    
    echo "======================================"
fi

# Re-enable readonly filesystem on SteamOS if it was disabled
if [[ $APPLY -eq 1 || $REVERT -eq 1 ]]; then
    if [[ -f /etc/os-release ]]; then
        source /etc/os-release 2>/dev/null || true
        if [[ "$ID" == "steamos" ]] || [[ "${ID_LIKE:-}" =~ "steamos" ]]; then
            log_info "Re-enabling readonly filesystem on SteamOS..."
            steamos-readonly enable 2>/dev/null || {
                # Fallback method for older SteamOS
                btrfs property set -ts / ro true 2>/dev/null || true
            }
            log_success "Filesystem secured"
        fi
    fi
fi
