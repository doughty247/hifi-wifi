# hifi-wifi v3.0.0-beta4 Release Notes

**Release Date:** February 3, 2026

## Overview

Beta4 integrates performance optimizations from external contributor cat-in-a-box, eliminating WiFi scan latency spikes and adding intelligent CAKE RTT detection. This release focuses on reducing latency and improving Steam Deck OLED support.

---

## New Features

### 1. **Scan Suppression** (Latency Fix)

**Problem:** Background WiFi scans cause periodic 150ms+ latency spikes during gaming
**Solution:** Active scan abort task eliminates spikes, reducing latency to 3-5ms average

```bash
sudo hifi-wifi scan-suppress on      # Enable (default)
sudo hifi-wifi scan-suppress off     # Disable (enables roaming)
hifi-wifi scan-suppress status       # Show current state
```

**Trade-off:** When enabled, roaming and band steering are temporarily disabled while connected (scans resume on disconnect)

Configuration in `~/.config/hifi-wifi/config.toml`:
```toml
[governor]
scan_suppress = true  # default
```

### 2. **Power-Save CLI Command** (Persistent Control)

**Replaces:** `--force-performance` flag (removed in beta4)
**New:** Persistent power save control surviving sleep/reboot

```bash
sudo hifi-wifi power-save off        # Maximum performance (persists)
sudo hifi-wifi power-save on         # Battery saving (persists)
sudo hifi-wifi power-save adaptive   # Automatic (default)
hifi-wifi power-save status          # Show configuration + actual state
```

**Persistence:** Writes NetworkManager config + hifi-wifi config, survives reboot and sleep cycles

### 3. **CAKE RTT Auto-Detection**

**Old Behavior:** Hardcoded 100ms RTT for all networks
**New Behavior:** Pings default gateway, auto-selects appropriate RTT:
- < 5ms RTT → 20ms CAKE parameter (local WiFi)
- < 20ms RTT → 50ms CAKE parameter (mesh/multi-hop)
- ≥ 20ms RTT → 100ms CAKE parameter (high latency)

**Dynamic Re-measurement:** RTT cache clears on connection events (fixes VPN/roaming scenarios)

### 4. **NAPI Busy Polling**

Kernel-level optimization reducing per-packet latency by ~50-100μs

**Sysctls applied:**
- `net.core.busy_poll = 50`
- `net.core.busy_read = 50`

**Per-interface:**
- `napi_defer_hard_irqs = 2`
- `gro_flush_timeout = 20000ns`

Degrades gracefully on kernels < 5.10

### 5. **Steam Deck OLED IRQ Fix**

**Critical Bugfix:** OLED kernel uses lowercase "mhi" in `/proc/interrupts`, LCD uses uppercase "MHI"
**Solution:** Case-insensitive IRQ matching now catches both variants
**Impact:** IRQ affinity optimization now works on Steam Deck OLED

---

## Breaking Changes

### Removed `--force-performance` Flag

**Old:**
```bash
sudo hifi-wifi apply --force-performance
```

**New:**
```bash
sudo hifi-wifi power-save off  # Persistent, survives reboots
```

**Rationale:** Power-save command is superior (persistent across sleep/reboot, more granular control)

---

## Bug Fixes

### RTT Cache Invalidation on Connection Events

**Issue:** Gateway RTT cached for entire daemon lifecycle, causing bufferbloat after VPN/roaming
**Fix:** RTT cache now clears on WiFi connection events, re-measures on next CAKE application
**Implementation:** Changed from `OnceLock` to `RwLock<Option<String>>` for dynamic updates

---

## Performance Improvements

**Scan Suppression Impact:**
- Average latency: 20ms → 3.5ms
- Max latency spikes: 170ms → 4ms
- ~95% reduction in WiFi-induced jitter

**NAPI Busy Polling:**
- Per-packet latency reduction: 50-100μs
- Most beneficial during high PPS gaming scenarios

**CAKE RTT Optimization:**
- Local WiFi: 80% less queue delay (100ms → 20ms RTT parameter)
- Mesh networks: 50% improvement (100ms → 50ms RTT parameter)

---

## Configuration

New `config.toml` section:

```toml
[governor]
# ... existing config ...

# Suppress background scans to eliminate latency spikes
# Trade-off: Disables roaming while connected
scan_suppress = true  # default: true

[power]
# WiFi power save mode: "off", "on", "adaptive"
# "off" = maximum performance (no power saving)
# "on" = battery saving (higher latency)
# "adaptive" = automatic based on AC/battery (default)
wlan_power_save = "adaptive"
```

---

## Updated Commands

| Command | Description |
|---------|-------------|
| `hifi-wifi status` | Check system status |
| `sudo hifi-wifi power-save off` | Maximum performance (persists) |
| `sudo hifi-wifi power-save adaptive` | Automatic mode (default) |
| `hifi-wifi power-save status` | Show power save state |
| `sudo hifi-wifi scan-suppress on` | Enable scan suppression (default) |
| `sudo hifi-wifi scan-suppress off` | Allow background scans (enables roaming) |
| `hifi-wifi scan-suppress status` | Show scan suppression state |
| `sudo hifi-wifi on/off` | Start/stop service |
| `sudo hifi-wifi uninstall` | Remove completely |

---

## Testing & Validation

**Tested on:**
- Steam Deck OLED (QCA2066 / ath11k_pci)
- Steam Deck LCD (RTL8822CE / rtw88_8822ce)
- 2.4GHz / 5GHz / 6GHz networks

**Validation:**
- Latency measurements via `ping -i 0.01` during scan events
- CAKE RTT verification on local/VPN/mesh networks
- Power-save persistence across sleep/reboot cycles
- IRQ affinity on Steam Deck OLED `/proc/interrupts`

---

## Upgrade Notes

### From Beta3

1. **Manual Migration:** If using `--force-performance`, switch to:
   ```bash
   sudo hifi-wifi power-save off
   ```

2. **Config Compatibility:** Existing configs compatible, new fields use defaults

3. **Service Restart:** Recommended after upgrade:
   ```bash
   sudo systemctl restart hifi-wifi
   ```

### New Installations

No special considerations - all features enabled by default with sane defaults

---

## Known Issues

None at this time. Beta3 persistence issues fully resolved.

---

## Credits

**External Contributions:**
- cat-in-a-box: Scan suppression, power-save CLI, CAKE RTT detection, NAPI busy polling, OLED IRQ fix

**Integration & Improvements:**
- Dynamic RTT cache invalidation on connection events
- Config structure harmonization
- Documentation and testing

---

## Roadmap

**Upcoming (v3.0.0 Stable):**
- Telemetry (opt-in) for success/failure tracking
- Additional network backend support (iwd improvements)
- Firmware update feature (experimental branch, separate release)

**Future:**
- Machine learning for adaptive CAKE tuning
- Per-SSID configuration profiles
- GUI/TUI for configuration management

---

## See Also

- [v3.0.0-beta3 Release Notes](v3.0.0-beta3.md) - Persistence fixes
- [Main README](../README.md) - Installation and usage
- [Configuration Guide](../docs/configuration.md) - Advanced tuning
