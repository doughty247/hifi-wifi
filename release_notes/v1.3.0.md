# v1.3.0 - Stability & Performance Overhaul

**Release Focus**: Eliminated race conditions, optimized dispatcher performance, and fixed critical power management issues affecting Steam Deck battery life.

---

## üî• Critical Fixes

### Race Condition Eliminated ([#5](https://github.com/doughty247/hifi-wifi/issues/5), [#6](https://github.com/doughty247/hifi-wifi/issues/6))
**Problem**: Two mechanisms (systemd service + NetworkManager dispatcher) were applying CAKE simultaneously, causing 4+ second delays and stuttering when connecting to WiFi.

**Solution**: 
- **Removed** systemd `wifi-cake-qdisc@.service` entirely
- NetworkManager dispatcher is now the **single source of truth**
- CAKE applies in ~1 second (was 4-8 seconds)

### Steam Deck Battery Fix üîã
**Problem**: Power save mode detection was broken on USB-C charging devices and desktops with wireless mice, causing Steam Deck to stay in power-save mode even when plugged in (killing performance) or performance mode on battery (draining faster).

**Solution**:
- **Fixed**: AC detection now checks power supply `type=` field (Mains/USB) instead of name patterns
- **Fixed**: Ignores device batteries (mouse, keyboard, UPS) - only system batteries (BAT0/BAT1) trigger power saving
- **Supports**: Steam Deck USB-C charging, traditional laptop AC adapters, desktop systems
- **Enhanced**: Logging now shows power mode decision source for debugging

---

## ‚ö° Performance Improvements

### Instant CAKE Application
- **Removed**: `is_network_idle()` 4+ second delay
- **Removed**: IFB download shaping (caused rollback errors, minimal benefit)
- **Result**: CAKE applies immediately on connection (no waiting, no idle checks)

### Wake-from-Sleep Resilience
- **Added**: Link speed detection retry logic (3 attempts, 0.5s delay)
- **Fixed**: Dispatcher no longer fails when WiFi adapter is still initializing after wake

### Timeout Protection
- **Added**: 0.5s timeouts on all battery/AC status reads
- **Fixed**: Hanging dispatcher when charging indicators get stuck

### Interface Filtering
- **Added**: Skip loopback and virtual interfaces (lo, tun, tap, veth, docker, br-, virbr, tailscale)
- **Fixed**: Dispatcher no longer tries to apply CAKE to non-physical interfaces

---

## üÜï New Features

### Clean Uninstaller
- **New**: `uninstall.sh` script with complete removal (13-step cleanup)
- **SteamOS-aware**: Skips `--revert` to keep filesystem writable
- **Supports**: All versions v1.0.0-v1.3.x (removes legacy configs)

### Legacy Install Detection
- **Added**: Automatic detection of pre-1.3.0 installs
- **Fixed**: Version check now correctly identifies installs without share directory
- **Enhanced**: Post-install prompt asks if user wants to apply optimizations immediately

### Enhanced Status Display
- **Improved**: `hifi-wifi --status` now uses color-coded sections
- **Fixed**: Recent Activity section displays correctly (was broken by subshell)
- **Added**: Process substitution for reliable output

---

## üêõ Bug Fixes

### Power Management
- ‚úÖ WiFi power save mode now dynamically responds to AC/battery status
- ‚úÖ Desktop systems always use performance mode (ignores device batteries)
- ‚úÖ Battery timeout protection prevents hangs from stuck indicators

### Dispatcher Stability  
- ‚úÖ Removed race condition with systemd service
- ‚úÖ Interface filtering prevents errors on virtual devices
- ‚úÖ Link speed retry logic handles wake-from-sleep
- ‚úÖ Timeout protection prevents battery read hangs

### Installation & Upgrades
- ‚úÖ Legacy install detection works correctly
- ‚úÖ Version comparison handles pre-1.3.0 installs
- ‚úÖ Uninstaller doesn't break SteamOS read-only filesystem
- ‚úÖ Post-install optimization prompt for immediate apply

### Disabled Features
- ‚ö†Ô∏è `--force-performance` temporarily disabled (broken, scheduled for v1.4.0)
- Shows deprecation notice when used

---

## üìã Technical Details

### Architecture Changes
- **Removed**: `wifi-cake-qdisc@.service` systemd service (race condition source)
- **Removed**: IFB download shaping (unreliable, minimal benefit)
- **Removed**: `is_network_idle()` check (unnecessary 4+ second delay)
- **Simplified**: Dispatcher is single source of CAKE truth

### Power Mode Detection
```bash
# Decision tree:
1. No system battery (BAT0/BAT1) ‚Üí Desktop ‚Üí Performance mode
2. Has system battery ‚Üí Check power supplies:
   - type=Mains online=1 ‚Üí AC connected ‚Üí Performance
   - type=USB online=1   ‚Üí USB-C charging ‚Üí Performance  
   - Fallback: Battery status=Charging/Full ‚Üí Performance
   - Otherwise ‚Üí Battery mode ‚Üí Power save
```

### Supported Platforms
- ‚úÖ Steam Deck (USB-C charging via `type=USB`)
- ‚úÖ Bazzite laptop (AC adapter via `type=Mains`)
- ‚úÖ SteamOS desktop (performance mode)
- ‚úÖ Bazzite desktop (ignores device batteries)

---

## üì¶ Upgrade Notes

### From v1.2.x or earlier:
```bash
# Automatic legacy detection handles upgrade
sudo ./install.sh
# Will prompt: "Would you like to apply network optimizations now? [Y/n]"
```

### Manual dispatcher update:
```bash
sudo cp src/dispatcher.sh /etc/NetworkManager/dispatcher.d/99-wifi-auto-optimize
sudo chmod +x /etc/NetworkManager/dispatcher.d/99-wifi-auto-optimize
```

### Complete uninstall:
```bash
sudo ./uninstall.sh  # Works on SteamOS and standard Linux
```

---

## ‚ö†Ô∏è Known Limitations

### Power Mode Switching
Power mode only updates on **NetworkManager connection events** (WiFi connect/disconnect), not on AC plug/unplug during active connection.

**Workaround**: 
- Disconnect and reconnect WiFi after plugging/unplugging AC
- Or run: `sudo hifi-wifi --apply` to force refresh

**Future**: Dynamic AC monitoring planned for v1.4.0

### Disabled Features
- `--force-performance` flag is disabled (will be fixed in v1.4.0)
- Shows notice: "This flag is currently disabled due to conflicts with dynamic power management"

---

## üîç Testing

All changes tested on:
- Bazzite desktop (wireless mouse battery present)
- Steam Deck use cases simulated
- Wake-from-sleep scenarios
- Legacy install upgrade path

Run test suite:
```bash
./tests/test-power-detection.sh  # Power mode detection
./tests/wifi-grader.sh           # Network performance
```

---

## üìä Statistics

- **Code removed**: ~150 lines (simpler architecture)
- **Commits**: 9 (race condition fixes, power management, stability)
- **Issues closed**: #5 (stuttering), #6 (power save)
- **Apply time**: ~1 second (was 4-8 seconds)
