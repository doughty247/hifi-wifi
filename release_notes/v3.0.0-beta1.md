# hifi-wifi v3.0.0-beta1 Release Notes

**Release Date:** January 11, 2026  
**Status:** Beta - Ready for Testing

---

## TL;DR for Gamers

hifi-wifi v3.0 is a complete rewrite in Rust. It runs quietly in the background and does the following automatically:

- **Eliminates lag spikes** by preventing your router's buffer from filling up (bufferbloat)
- **Freezes network settings during gameplay** so nothing changes mid-match
- **Adapts to your connection** - bandwidth limits adjust every 2 seconds based on your actual link speed
- **Manages power intelligently** - full performance on AC, battery saving when unplugged (but switches to performance if network activity is detected)
- **Supports both WiFi and Ethernet** - optimizes whatever you're connected with
- **Survives system updates** on SteamOS and Bazzite

Just install it and forget it. Check status anytime with `hifi-wifi status`.

---

## TL;DR for Testers

This is the first beta of the v3.0 Rust rewrite. Key testing areas:

1. **Installation** - Does `sudo ./install.sh` work cleanly on your distro?
2. **Service stability** - Does `systemctl status hifi-wifi` stay active for 24+ hours?
3. **CAKE activation** - Does `hifi-wifi status` show CAKE as ACTIVE with reasonable bandwidth?
4. **Power transitions** - Does AC/battery switching work without network hiccups?
5. **Game mode** - During online gaming (>200 PPS), does bandwidth stay frozen?
6. **Ethernet** - If using wired, does EEE toggle correctly based on power source?
7. **SteamOS/Bazzite** - Does the service survive system updates and reboots?

**How to report issues:**
```bash
hifi-wifi status > status.txt
journalctl -u hifi-wifi --no-pager -n 100 > logs.txt
```
Include both files in your GitHub issue.

---

## What's New in v3.0

### Complete Rust Rewrite

The entire codebase has been rewritten from shell scripts to Rust. This brings:

- **Lower resource usage** - ~12MB memory (64MB limit), <1% CPU
- **Better reliability** - No more shell parsing edge cases
- **Faster response** - Native async I/O with tokio
- **Type safety** - Catches configuration errors at compile time
- **Single binary** - No script dependencies

### Breathing CAKE v2 (Dynamic QoS)

The traffic shaping system has been completely redesigned:

- **Asymmetric response**: Bandwidth drops apply in 2 seconds (prevents bufferbloat), increases take 6 seconds (prevents oscillation)
- **Game mode freeze**: When gaming is detected (>200 packets/sec), CAKE bandwidth is locked to prevent mid-game changes
- **Dual-source bandwidth**: Reads from both NetworkManager and `iw` to handle driver quirks
- **Throughput validation**: Compares PHY rate against actual measured throughput
- **Median filtering**: 3-sample rolling window removes MCS0 probe frame noise
- **Last known good**: Maintains bandwidth during idle periods instead of disabling CAKE

### Intelligent Power Management

- **Adaptive power save**: On AC = performance mode, on battery = power saving
- **Activity override**: Automatically disables power save during network activity (>50 PPS)
- **6-second hysteresis**: Brief charger disconnects don't cause network hiccups
- **EEE management**: Energy Efficient Ethernet disabled on AC for lower latency on wired connections

### Ethernet Support

New in v3.0 - wired connections are now detected and optimized:

- **EEE (Energy Efficient Ethernet)**: Dynamically disabled on AC power to eliminate 50-200us wakeup latency
- **Interrupt coalescing**: Adjusted based on CPU load and game mode
- **Initial CAKE**: Applied on startup at 60% of link speed (e.g., 600Mbit for gigabit ethernet)

Note: The governor's dynamic bandwidth monitoring currently focuses on WiFi interfaces. Ethernet receives CAKE configuration at startup based on link speed.

### Comprehensive Jitter Prevention

Multiple hysteresis layers prevent settings from flapping:

- **CAKE bandwidth**: 3 ticks (6 sec) before increasing, 1 tick (2 sec) before decreasing
- **Power save**: 3 ticks (6 sec) before toggling
- **Interrupt coalescing**: 2 ticks (4 sec) before toggling
- **Band steering**: 3 ticks (6 sec) before recommending roam

### Enhanced Status Display

The `hifi-wifi status` command now shows:

- Service state (ACTIVE/INACTIVE)
- Device type and power source with battery percentage
- Per-interface breakdown: CAKE status with bandwidth, power save state, IRQ pinning, EEE status
- Network governor state: backend, QoS mode, game mode availability
- Active connection details: SSID, BSSID, band, channel, signal strength, link speed, band steering score

### Robust SteamOS/Bazzite Support

- **Survives system updates**: Binary installed to /var/lib/hifi-wifi (persists across A/B updates)
- **Self-healing symlinks**: Recreates /usr/local/bin/hifi-wifi after updates
- **SELinux support**: Properly sets bin_t context on Bazzite/Fedora
- **Read-only filesystem handling**: Automatic unmerge/remount on SteamOS
- **Integrated build setup**: Installer handles pacman initialization on SteamOS

---

## Installation

### Quick Install

```bash
git clone -b dev https://github.com/doughty247/hifi-wifi.git
cd hifi-wifi
sudo ./install.sh
```

The installer will:
1. Detect your platform (SteamOS, Bazzite, Arch, etc.)
2. Install Rust toolchain if needed
3. Build the release binary
4. Install to /var/lib/hifi-wifi/
5. Create and start the systemd service
6. Apply initial optimizations

### Upgrading from v1.x

If you have a previous version installed:

```bash
cd hifi-wifi
git pull origin dev
sudo ./install.sh
```

The installer stops the existing service before upgrading.

---

## CLI Commands

| Command | Description |
|---------|-------------|
| `hifi-wifi status` | Show current optimization state |
| `sudo hifi-wifi monitor` | Run in foreground with live logging |
| `sudo hifi-wifi apply` | Apply optimizations once (no daemon) |
| `sudo hifi-wifi revert` | Remove all optimizations |
| `sudo hifi-wifi on` | Start service (for A/B testing) |
| `sudo hifi-wifi off` | Stop service and revert (for A/B testing) |
| `sudo hifi-wifi install` | Install/reinstall systemd service |
| `sudo hifi-wifi uninstall` | Remove systemd service |

---

## Configuration

Config file: `/etc/hifi-wifi/config.toml`

The config file is optional. If not present, sensible defaults are used. Create the file manually to customize behavior.

### Key Settings

```toml
[global]
tick_rate_secs = 2

[power]
wlan_power_save = "adaptive"  # "on", "off", or "adaptive"

[governor]
breathing_cake_enabled = true
game_mode_enabled = true
game_mode_pps_threshold = 200
game_mode_freeze_cake = true
band_steering_enabled = true
cpu_coalescing_enabled = true

[system]
sysctl_enabled = true
irq_affinity_enabled = true
driver_tweaks_enabled = true
```

---

## Supported Hardware

### WiFi Drivers (Tested)
- Intel (iwlwifi) - Steam Deck LCD, laptops
- Qualcomm (ath11k) - Steam Deck OLED
- Realtek (rtl8192ee, rtl8xxxu)
- MediaTek (mt76)

### Ethernet Drivers (Tested)
- Realtek (r8169)
- Intel (e1000e, igb)

### Platforms (Tested)
- Bazzite (recommended)
- SteamOS 3.x (Steam Deck LCD and OLED)
- Arch Linux
- Fedora (with SELinux)

---

## Known Issues

1. **IRQ pinning shows DEFAULT on some systems**: This is expected if your driver doesn't expose a dedicated IRQ line in /proc/interrupts
2. **CAKE shows low bandwidth initially**: The median filter needs 2 samples (minimum) before making decisions
3. **Band steering triggers scan only**: When a better AP is found, hifi-wifi requests a NetworkManager scan rather than forcing a roam. Actual roaming depends on the driver and AP configuration

---

## Changelog (from v1.3.0)

### Major Changes
- Complete rewrite from shell scripts to Rust
- New Governor architecture with 2-second tick loop
- Breathing CAKE v2 with asymmetric response
- Added ethernet interface support
- Added game mode with CAKE freeze
- Added comprehensive hysteresis system

### New Features
- `hifi-wifi status` with detailed interface breakdown
- `hifi-wifi on/off` commands for A/B testing  
- EEE management for ethernet
- Dynamic interrupt coalescing
- Band steering score display
- Battery percentage in status
- Throughput-based bandwidth validation

### Fixes
- SELinux context for Bazzite/Fedora (service failed to start)
- SteamOS read-only filesystem handling
- Self-healing symlinks after system updates
- CAKE persistence during idle periods
- MCS0 probe frame filtering
- Steam Deck OLED (ath11k) stability
- IRQ detection for rtl8192ee (reports as rtl_pci)

### Removed
- Shell script dependencies
- wpa_supplicant backend switching (caused conflicts)
- speedtest-cli bandwidth detection (replaced with link statistics)
- IFB ingress shaping (unreliable)

---

## Feedback

Please report issues on GitHub: https://github.com/doughty247/hifi-wifi/issues

Include:
1. Output of `hifi-wifi status`
2. Recent logs: `journalctl -u hifi-wifi -n 50`
3. Your hardware: Steam Deck LCD/OLED, laptop model, etc.
4. What you were doing when the issue occurred
