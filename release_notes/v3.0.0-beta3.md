# v3.0.0-beta3 Release Notes

**Release Date:** February 3, 2026
**Status:** Beta - Bugfix Release

> [!IMPORTANT]  
> **Upgrading from v1.x?** Uninstall first: `cd legacy && sudo ./uninstall.sh && cd ..`

---

## Critical Bug Fixes

### #16 - Power Save Auto-Reenabling After Reconnection (CRITICAL)
**Problem:** After WiFi reconnection, sleep, or switching between Desktop/Game mode, NetworkManager resets power save to ON (default), but hifi-wifi's cache thinks it's still OFF. The hysteresis logic sees "no change needed" and never disables it again, causing unstable ping and connection drops.

**Additionally:** Daemon ignored config setting - users couldn't force power save OFF permanently.

**Fix:** 
- Clear all power management state on reconnection events
- Bypass 6-second hysteresis after reconnection for immediate application
- Power save now disabled within 2 seconds of reconnection (1s link stabilization + 1 tick)
- **NEW:** Daemon now respects `/etc/hifi-wifi/config.toml` power save setting:
  - `wlan_power_save = "off"` - Force OFF permanently (solves Issue #16)
  - `wlan_power_save = "on"` - Force ON (battery saving)
  - `wlan_power_save = "adaptive"` - Auto (default behavior)
- **NEW:** `--force-performance` flag for quick testing: `sudo hifi-wifi apply --force-performance`

**Impact:** Power save stays disabled across reconnections, sleep/wake, and mode switches. Users can force it OFF permanently via config.

### #15 - CAKE Inactive After Install
**Problem:** After reconnection or service start, CAKE requires 2-3 warmup samples (4-6 seconds) before applying. During warmup, interface has no traffic shaping, causing lag spikes.

**Fix:**
- Force immediate CAKE application after reconnection with conservative 85Mbit default
- Dynamic adjustment takes over after warmup samples arrive
- CAKE now active within 1 second of reconnection instead of 6+ seconds

**Impact:** Zero-gap traffic shaping across reconnections.

### Persistence Fix - Service Not Active After Reboot
**Problem:** Install/apply completed, but the systemd service was not consistently enabled at boot, leaving the governor inactive after reboot. This caused CAKE to be inactive and power save to revert to defaults.

**Fix:**
- `hifi-wifi apply` now enforces `systemctl enable --now hifi-wifi.service`
- Installer also enables and starts the service after install
- Status output clearly shows Governor Active/Inactive

**Impact:** Optimizations persist across reboots without manual steps.

### Ethernet CAKE Re-Apply on Boot
**Problem:** If the daemon started before carrier was up, CAKE could remain inactive on Ethernet even though the governor was running.

**Fix:**
- Governor now checks active Ethernet links each tick and applies CAKE if missing

**Impact:** Ethernet CAKE reliably comes up after boot and link negotiation.

---

## Technical Details

### Connection Event Handling Improvements
After a WiFi reconnection (wake from sleep, manual disconnect/reconnect, switching networks):

**Before:**
1. Bitrate cache cleared
2. Power save state KEPT (cache mismatch → hysteresis blocks fix)
3. CAKE not applied until warmup complete (~6 seconds)
4. Result: 6+ seconds of degraded performance

**After:**
1. All state cleared (bitrate, power save, EEE, coalescing)
2. Bypass flag set for immediate power save application
3. CAKE force-applied at conservative 85Mbit
4. Dynamic adjustments resume after warmup
5. Result: <2 seconds to full optimization

### Code Changes
- [`src/network/governor.rs`](../src/network/governor.rs):
  - Added `bypass_power_save_hysteresis` flag to `InterfaceState`
  - `handle_connection_event()`: Clear all cached state + force CAKE application
  - Power save hysteresis: 0 ticks when bypass flag set (immediate), 3 ticks normally

---

## Testing Checklist

**Please test reconnection scenarios:**

- [ ] WiFi disconnect/reconnect: `iw dev wlan0 get power_save` stays off
- [ ] Sleep/wake: Power save remains disabled after suspend/resume
- [ ] Desktop ↔ Game mode: Power save settings persist across mode switches
- [ ] CAKE active immediately: `tc qdisc show dev wlan0` shows CAKE <2s after reconnect
- [ ] No lag spikes during reconnection warmup
- [ ] **NEW:** Config override: Create `/etc/hifi-wifi/config.toml` with `wlan_power_save = "off"`, restart service, verify power save stays OFF even on battery
- [ ] **NEW:** Reboot persistence: After reboot, `hifi-wifi status` shows Governor Active and CAKE active on Ethernet

**Report issues:** Attach `{ hifi-wifi status; journalctl -u hifi-wifi -n 100; } > report.txt`

---

## Commands

| Command | Description |
|---------|-------------|
| `hifi-wifi status` | Show current WiFi state and optimization status |
| `sudo hifi-wifi apply --force-performance` | Apply optimizations with power save forced OFF |
| `sudo hifi-wifi monitor --force-performance` | Run daemon with power save forced OFF |
| `sudo hifi-wifi monitor` | Watch live logs (Ctrl+C to exit) |
| `sudo hifi-wifi on/off` | Start/stop the service |
| `journalctl -u hifi-wifi -f` | Follow logs in real-time |

---

## Installation

```bash
# Download release
wget https://github.com/doughty247/hifi-wifi/archive/v3.0.0-beta3.tar.gz
tar -xzf v3.0.0-beta3.tar.gz
cd hifi-wifi-3.0.0-beta3

# Install (builds from source, sets up systemd)
sudo ./install.sh

# Check status
hifi-wifi status
```

---

## Known Issues

- **Multiple networks**: May not prioritize ethernet over WiFi when both connected
- **6GHz support**: Band steering logic needs improvement for tri-band routers
- **IRQ Pinning**: Detection logic incomplete (low priority enhancement)

---

**Full changelog:** [beta2...beta3](https://github.com/doughty247/hifi-wifi/compare/v3.0.0-beta2...v3.0.0-beta3)
